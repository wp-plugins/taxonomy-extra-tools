<?php
if( !class_exists('CustomTaxonomyInNavMenu') ) {
	class CustomTaxonomyInNavMenu {
		
		function CustomTaxonomyInNavMenu() {
			add_action( 'admin_head-nav-menus.php', array( &$this, 'tet_navmenu_metabox' ) );
			add_filter( 'wp_get_nav_menu_items', array( &$this,'tet_archive_menu_filter'), 10, 3 );
		}
		
		function tet_navmenu_metabox() {
	    	add_meta_box( 'add-tet', __('Custom Taxonomy Archives', 'taxonomy-extra-tools'), array( &$this, 'tet_navmenu_metabox_content' ), 'nav-menus', 'side', 'default' );
	  	}
		
		function tet_navmenu_metabox_content() {
	    	$post_types = get_post_types( array( 'show_in_nav_menus' => true, 'has_archive' => true ), 'object' );
			
			$args = array(
				'public'   => true,
				'_builtin' => false	  
			); 
			$output = 'objects'; // or names
			$operator = 'and'; // 'and' or 'or'
			$taxonomies = get_taxonomies( $args, $output, $operator );
			
			
			if( $taxonomies ) :
				foreach ( $taxonomies as &$taxonomy ) {
			        $taxonomy->classes = array();
			        $taxonomy->type = $taxonomy->query_var;
			        $taxonomy->object_id = $taxonomy->name;
			        $taxonomy->title = sprintf( __( '%s Archive', 'taxonomy-extra-tools' ),$taxonomy->labels->name);
			        $taxonomy->object = 'taxonomy-archive';
			    }
				$walker = new Walker_Nav_Menu_Checklist( array() );
		
				echo '<div id="tet-archive" class="posttypediv">';
				echo '<div id="tabs-panel-tet-archive" class="tabs-panel tabs-panel-active">';
				echo '<ul id="tet-archive-checklist" class="categorychecklist form-no-clear">';
				echo walk_nav_menu_tree( array_map('wp_setup_nav_menu_item', $taxonomies), 0, (object) array( 'walker' => $walker) );
				echo '</ul>';
				echo '</div><!-- /.tabs-panel -->';
				echo '</div>';
				echo '<p class="button-controls">';
				echo '<span class="add-to-menu">';
				echo '<img class="waiting" src="' . esc_url( admin_url( 'images/wpspin_light.gif' ) ) . '" alt="" />';
				echo '<input type="submit"' . disabled( $nav_menu_selected_id, 0 ) . ' class="button-secondary submit-add-to-menu" value="' . __('Add to Menu', 'taxonomy-extra-tools') . '" name="add-tet-archive-menu-item" id="submit-tet-archive" />';
				echo '</span>';
				echo '</p>';
				
			endif;
		}
		
		function tet_archive_menu_filter( $items, $menu, $args ) {
	    	foreach( $items as &$item ) {
	      		if( $item->object != 'taxonomy-archive' ) continue;
	      		$item->url = get_site_url( $item->rewrite['slug'] );
	      echo '<pre>itemurl'; print_r($item->url); echo '</pre>';
	      		if( get_query_var( 'taxonomy' ) == $item->type ) {
	       			$item->classes[] = 'current-menu-item';
	        		$item->current = true;
	      		}
	    	}
	    	
	    	return $items;
		}
	}

	/* Instantiate the plugin */
	$CustomTaxonomyInNavMenu = new CustomTaxonomyInNavMenu();
}
?>